<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Weight Trend Analysis</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .section-card { background:#fff; border-radius:14px; padding:20px; box-shadow:0 6px 18px rgba(0,0,0,0.06); margin:18px auto; max-width:900px; }
    .header-container { display:flex; justify-content:space-between; align-items:center; padding:16px 24px; background:#0f172a; color:#fff; }
    .nav a { color:#cbd5e1; margin-left:14px; text-decoration:none; }
    .muted { color:#64748b; font-size:0.9rem; }
  </style>
</head>
<body>
  <header class="header-container">
    <div><strong>Weight Trend Analysis</strong></div>
    <div class="nav">
      <a href="/">Home</a>
      <a href="/users/<%= user.id %>/weights">Back to Weights</a>
    </div>
  </header>

  <div class="section-card">
    <h1>Weight Trend for <%= user.firstName %> <%= user.lastName %></h1>
    <p class="muted">Below is a chart showing the weight trend over time. You can use this to monitor progress and spot trends.</p>
    <canvas id="weightChart" width="800" height="350"></canvas>
    <div style="margin-top:24px;">
      <h3>Analysis</h3>
      <% if (weights && weights.length > 1) { %>
        <ul>
          <li>Starting weight: <strong><%= weights[0].weight_kg %> kg</strong> on <%= new Date(weights[0].taken_at_utc).toLocaleDateString() %></li>
          <li>Latest weight: <strong><%= weights[weights.length-1].weight_kg %> kg</strong> on <%= new Date(weights[weights.length-1].taken_at_utc).toLocaleDateString() %></li>
          <li>Change: <strong><%= (weights[weights.length-1].weight_kg - weights[0].weight_kg).toFixed(2) %> kg</strong></li>
          <li>Average weight: <strong><%= (weights.reduce((a, w) => a + parseFloat(w.weight_kg), 0) / weights.length).toFixed(2) %> kg</strong></li>
          <% if (user && user.height_cm) { 
               const heightM = user.height_cm / 100;
               const bmi = (weights[weights.length-1].weight_kg / (heightM * heightM)).toFixed(2);
          %>
            <li>Latest BMI: <strong><%= bmi %></strong> (using height <%= user.height_cm %> cm)</li>
            <li>BMI Category: <strong>
              <% if (bmi < 18.5) { %>Underweight<% } else if (bmi < 25) { %>Normal<% } else if (bmi < 30) { %>Overweight<% } else { %>Obese<% } %>
            </strong></li>
          <% } else { %>
            <li class="muted">No height data for BMI calculation.</li>
          <% } %>
        </ul>
      <% } else { %>
        <div class="muted">Not enough data for analysis.</div>
      <% } %>
    </div>
  </div>

  <script>
    var labels = <%- JSON.stringify(weights.map(w => new Date(w.taken_at_utc).toLocaleDateString())) %>;
    var data = <%- JSON.stringify(weights.map(w => w.weight_kg)) %>;
  </script>
  <script>
    if (labels.length > 0) {
      const ctx = document.getElementById('weightChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Weight (kg)',
            data: data,
            borderColor: '#0ea5e9',
            backgroundColor: 'rgba(14,165,233,0.1)',
            fill: true,
            tension: 0.2,
            pointRadius: 4,
            pointBackgroundColor: '#0ea5e9',
            pointBorderColor: '#fff',
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            title: { display: false }
          },
          scales: {
            x: { title: { display: true, text: 'Date' } },
            y: { title: { display: true, text: 'Weight (kg)' }, beginAtZero: false }
          }
        }
      });
    }
  </script>
</body>
</html>
