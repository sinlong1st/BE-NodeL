<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= pageTitle || "Alt App" %></title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        /* Inline styles for quick adjustment */
        .content-container {
            display: flex;
            gap: 20px;
            margin: 20px;
            justify-content: center;
            align-items: flex-start;
        }

    </style>
</head>
<body>
    <header class="header-container">
        <div class="header-title">
            <%= headerTitle || "Welcome!" %>
        </div>
        <div class="nav">
            <a href="/">Home</a>
            <a href="/about">About</a>
            <a href="/register">Register</a>
            <a href="/stats">Reports</a>
        </div>
    </header>
    <main style="max-width: 900px; margin: 2rem auto; font-family: Arial, sans-serif;">
        <h1 style="text-align: left;">STATISTICS</h1>
        <h2 style="text-align: left;">Total Balance: $<%= totalBalance%></h2>

        <section style="display: flex; gap: 2rem; flex-wrap: wrap; justify-content: center;">
            <!-- Line Chart -->
            <div style="flex: 1 1 400px;">
            <h2>Monthly Growth</h2>
            <canvas id="lineChart"></canvas>
            </div>

            <!-- Bar Chart -->
            <div style="flex: 1 1 400px;">
            <h2>Account Balance Stats</h2>
            <canvas id="barChart"></canvas>
            </div>
        </section>

        <!-- Active Users List -->
        <section style="margin: 2rem 0;">
            <h2>Active Users (with weight records)</h2>
            <% if (activeUsers && activeUsers.length) { %>
                <table style="width:100%; max-width:700px; margin:auto; border-collapse:collapse; border:1px solid #e2e8f0;">
                    <thead>
                        <tr style="background:#f1f5f9;">
                            <th style="padding:8px; border:1px solid #e2e8f0;">Name</th>
                            <th style="padding:8px; border:1px solid #e2e8f0;"># Weights</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% activeUsers.forEach(u => { %>
                            <tr>
                                <td style="padding:8px; border:1px solid #e2e8f0;"><%= u.firstName %> <%= u.lastName %></td>
                                <td style="padding:8px; border:1px solid #e2e8f0; text-align:center;"><%= u.weightCount %></td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            <% } else { %>
                <div style="color:#64748b;">No active users found.</div>
            <% } %>
        </section>

        <!-- Good Health BMI Ranking Chart -->
        <section style="margin: 2rem 0;">
                <h2>Ranking: Top 5 Users by BMI (All Categories)</h2>
                    <% let bmiRankingColors = [], bmiRankingBorders = [];
                            if (goodHealthRanking && goodHealthRanking.length) { 
                                bmiRankingColors = goodHealthRanking.map(u => {
                                    if (u.category === 'Underweight') return '#e0e7ff';
                                    if (u.category === 'Normal') return '#dcfce7';
                                    if (u.category === 'Overweight') return '#fef9c3';
                                    return '#fee2e2';
                                });
                                bmiRankingBorders = goodHealthRanking.map(u => {
                                    if (u.category === 'Underweight') return '#1e40af';
                                    if (u.category === 'Normal') return '#15803d';
                                    if (u.category === 'Overweight') return '#b45309';
                                    return '#dc2626';
                                });
                    %>
                                <div style="max-width:480px; margin:0 auto;">
                                    <canvas id="bmiRankingChart" height="180" style="max-width:100%;"></canvas>
                                </div>
                <table style="width:100%; max-width:700px; margin:18px auto 0 auto; border-collapse:collapse; border:1px solid #e2e8f0;">
                                <div style="max-width:700px; margin:18px auto 0 auto; color:#64748b; font-size:1em; background:#f8fafc; border-radius:8px; padding:12px 18px;">
                                    <strong>How is this ranking calculated?</strong><br>
                                    The top 5 users are ranked by how close their latest BMI is to 22 (the middle of the 'Normal' BMI range). All BMI categories are included. Bar and tag colors match the BMI category: <span style="color:#1e40af;">Underweight</span>, <span style="color:#15803d;">Normal</span>, <span style="color:#b45309;">Overweight</span>, <span style="color:#dc2626;">Obese</span>.
                                </div>
                    <thead>
                        <tr style="background:#f1f5f9;">
                            <th style="padding:8px; border:1px solid #e2e8f0;">Rank</th>
                            <th style="padding:8px; border:1px solid #e2e8f0;">Name</th>
                            <th style="padding:8px; border:1px solid #e2e8f0;">BMI</th>
                            <th style="padding:8px; border:1px solid #e2e8f0;">Category</th>
                        </tr>
                    </thead>
                    <tbody>
                    <% goodHealthRanking.forEach((u, idx) => { %>
                        <tr>
                            <td style="padding:8px; border:1px solid #e2e8f0; text-align:center;"><%= idx+1 %></td>
                            <td style="padding:8px; border:1px solid #e2e8f0; font-weight:bold;"><a href="/users/<%= u.id %>/weights"><%= u.name %></a></td>
                            <td style="padding:8px; border:1px solid #e2e8f0; text-align:center;"><%= u.bmi %></td>
                            <td style="padding:8px; border:1px solid #e2e8f0; text-align:center;">
                                <% if (u.category === 'Underweight') { %>
                                    <span style="display:inline-block; padding:2px 12px; border-radius:16px; background:#e0e7ff; color:#1e40af; font-weight:600;">Underweight</span>
                                <% } else if (u.category === 'Normal') { %>
                                    <span style="display:inline-block; padding:2px 12px; border-radius:16px; background:#dcfce7; color:#15803d; font-weight:600;">Normal</span>
                                <% } else if (u.category === 'Overweight') { %>
                                    <span style="display:inline-block; padding:2px 12px; border-radius:16px; background:#fef9c3; color:#b45309; font-weight:600;">Overweight</span>
                                <% } else { %>
                                    <span style="display:inline-block; padding:2px 12px; border-radius:16px; background:#fee2e2; color:#dc2626; font-weight:600;">Obese</span>
                                <% } %>
                            </td>
                        </tr>
                    <% }) %>
                    </tbody>
                </table>
<% } else { %>
        <div style="color:#64748b;">No users found for ranking.</div>
<% } %>
        </section>

        <!-- Chart.js CDN -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        
        <script>
            const accountHasBalance = JSON.parse('<%- JSON.stringify(accountHasBalance) %>');
            const accountNull = JSON.parse('<%- JSON.stringify(accountNull) %>');
            const totalAccount = JSON.parse('<%- JSON.stringify(totalAccount) %>');
            // Line Chart
            new Chart(document.getElementById("lineChart"), {
            type: "line",
            data: {
                labels: ["Mar", "Apr", "May", "Jun", "Jul", "Aug"],
                datasets: [{
                label: "Users",
                data: [0, 2, 4, 5, 7, totalAccount],
                borderColor: "rgba(54, 162, 235, 1)",
                backgroundColor: "rgba(54, 162, 235, 0.2)",
                fill: true,
                tension: 0.3
                }]
            }
            });

            // Bar Chart
            new Chart(document.getElementById("barChart"), {
            type: "bar",
            data: {
                labels: ["Account with Balance", "Account Empty"],
                datasets: [{
                label: "Accounts",
                data: [accountHasBalance, accountNull],
                backgroundColor: [
                    "rgba(54, 162, 235, 0.6)",
                    "rgba(255, 99, 132, 0.6)"
                ]
                }]
            },
            options: {
                plugins: {
                legend: { display: false }
                }
            }
            });

            // BMI Ranking Chart
            const bmiRankingLabels = JSON.parse('<%- JSON.stringify(goodHealthRanking.map(u => u.name)) %>');
            const bmiRankingData = JSON.parse('<%- JSON.stringify(goodHealthRanking.map(u => u.bmi)) %>');
            const bmiRankingColors = JSON.parse('<%- JSON.stringify(bmiRankingColors) %>');
            const bmiRankingBorders = JSON.parse('<%- JSON.stringify(bmiRankingBorders) %>');
            if (bmiRankingData && bmiRankingData.length) {
                new Chart(document.getElementById('bmiRankingChart'), {
                    type: 'bar',
                    data: {
                        labels: bmiRankingLabels,
                        datasets: [{
                            label: 'BMI',
                            data: bmiRankingData,
                            backgroundColor: bmiRankingColors,
                            borderColor: bmiRankingBorders,
                            borderWidth: 2,
                            barThickness: 25
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        scales: {
                            x: {
                                min: 15,
                                max: 40,
                                title: { display: true, text: 'BMI' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'BMI: ' + context.parsed.x;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        </script>
    </main>
    <footer>
        Built by <%= author || "Default Admin" %>
    </footer>
</body>
</html>
